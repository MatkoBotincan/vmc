import "permissions_logic";
import "blob_logic";


/********************************
 * Array logic with permissions
 ********************************/


/* Rules for contradictions */
 
rule array_array_contradiction:
  array(?h,?t,?p,?x,?l) * array(?h,?u,?q,?x,?l) | |- 
where
  !LT(0, ?l) pureguard
if


/* Get rid of arrays with length zero */

rule remove_empty_array_left :
  | array(?h,?t,?p,?x,?l) |-
where
  !LE(?l, 0) * !GE(?l, 0) pureguard
if
  | |-
  
rule remove_empty_array_right : 
  | |- array(?h,?t,?p,?x,?l)
where
  !LE(?l, 0) * !GE(?l, 0) pureguard
if 
  | |-


/* Array splitting */

rule array_split_blob:
  | array(?h,?t,?p,?x,?l) |- blob(?h,?t,?p,?y,_c)
where
  !LE(?x,?y) * !LE(?y,builtin_plus(?x,builtin_minus(?l,"1"))) pureguard
if
  blob(?h,?t,?p,?y,_c) | array(?h,?t,?p,?x,_k) * array(?h,?t,?p,builtin_plus(?y,"1"),builtin_minus(builtin_minus(?l,_k),"1")) |- _k = builtin_minus(?y,?x)
 

/* Arrays with zero permission reduce to emp */

rule array_perm_bot_left:
  | array(?h,?t,pbot(),?x,?l) |-
if
  | |-

rule array_perm_bot_right:
  | |- array(?h,?t,pbot(),?x,?l)
if
  | |-
 
rule array_perm_bot_elimination_left:
  | array(?h,?t,?p,?x,?l) * array(?h,?t,pbot(),?x,?l) |- 
if
  | array(?h,?t,?p,?x,?l) |-

rule array_perm_bot_elimination_right:
  | |- array(?h,?t,?p,?x,?l) * array(?h,?t,pbot(),?x,?l)
if
  | |- array(?h,?t,?p,?x,?l)


/* Permissions matching */

rule array_perm_pdiff_match:
  | array(?h,?t,?p,?x,?l) |- array(?h,?t,?q,?x,?l) 
without
  array(?h,?t,pbot(),?x,?l)
if
  array(?h,?t,?q,?x,?l) | array(?h,?t,?r,?x,?l) * ?r = pdiff(?p, ?q) |-

rule array_simple_match : 
  | array(?h,?t,?p,?x,?l1) |- array(?h,?t,?q,?x,?l2)
where
  !GE(?l1,?l2) pureguard
if 
  array(?h,?t,?p,?x,?l2) | array(?h,?t,?q,?x,(?l1-?l2)) |- 
